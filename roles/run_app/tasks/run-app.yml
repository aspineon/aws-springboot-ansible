---

- name: Stop Spring App Tomcat server
  raw: "LOG_FOLDER=/var/www/spring_app_{{ aws_profile }}_{{ item }} PID_FOLDER=/var/www/spring_app_{{ aws_profile }}_{{ item }} /etc/init.d/spring_app_{{ aws_profile }}_{{ item }} stop"
  ignore_errors: yes

- name: Start Spring App Tomcat server
  raw: "LOG_FOLDER=/var/www/spring_app_{{ aws_profile }}_{{ item }} PID_FOLDER=/var/www/spring_app_{{ aws_profile }}_{{ item }} /etc/init.d/spring_app_{{ aws_profile }}_{{ item }} start --spring.profiles.active={{ aws_profile }}"
  notify:
    - reload nginx
    - reload haproxy

- name: Pause for Spring to pick up
  pause: seconds=40

- name: Let's test the app and services are running
  uri:
    url: "http://localhost"
    return_content: yes
  register: test_response

- name: Ensure the app is doing what we want, if not we will pause the playbook
  pause: seconds="120"
  when: 'not "home" in test_response.content'
  ignore_errors: yes